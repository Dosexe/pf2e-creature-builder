<form>
    <h1>{{localize "PF2EMONSTERMAKER.title"}}</h1>
    <h2>{{localize "PF2EMONSTERMAKER.nameLevelRoadmap"}}</h2>
    <div class="form-group setting">
        <label for="monsterMakerName" class="monsterMakerFormText">
            {{localize "PF2EMONSTERMAKER.name"}}
        </label>
        <input id="monsterMakerName" name="PF2EMONSTERMAKER.name" placeholder="{{name}}" class="monsterMakerFormText">
    </div>
    <div class="form-group setting">
        <label for="monsterMakerLevel" class="monsterMakerFormText">
            {{localize "PF2EMONSTERMAKER.level"}}
        </label>
        <select name="PF2EMONSTERMAKER.level" id="monsterMakerLevel" class="monsterMakerFormTextSmall">
            {{#each Levels}}
                <option value={{this}}>{{this}}</option>
            {{/each}}
        </select>
    </div>
    <div class="form-group setting">
        <label for="monsterMakerRoadmap" class="monsterMakerFormText">
            {{localize "PF2EMONSTERMAKER.roadmap"}}
        </label>
        <select id="monsterMakerRoadmap" class="monsterMakerFormTextSmall" onchange=setRoadmap(this)>
            <option value="Default" selected>Default</option>
            {{#each RoadMaps}}
                <option value="{{@key}}">{{localize @key}}</option>
            {{/each}}
        </select>
    </div>
    <div class="form-group setting">
        <label for="monsterMakerTraits" class="monsterMakerFormText">
            {{localize "PF2EMONSTERMAKER.traits"}}
        </label>
        <div class="traits-container">
            <div id="traitsTagsContainer" class="traits-tags"></div>
            <input type="text" id="monsterMakerTraitsInput" class="monsterMakerFormText traits-input" placeholder="{{localize "PF2EMONSTERMAKER.traitsPlaceholder"}}">
        </div>
        <input type="hidden" name="PF2EMONSTERMAKER.traits" id="monsterMakerTraitsHidden" value="">
    </div>
    {{#each CreatureStatistics}}
        <h3>{{localize this.name}}</h3>
        {{#each this.statisticEntries}}
            <div class="form-group setting">
                <label for="{{concat 'monsterMaker' this.name}}" class="monsterMakerFormText">
                    {{localize this.name}}
                </label>
                <select id="{{concat 'monsterMaker' this.name}}" name="{{this.name}}" class="monsterMakerFormTextSmall">
                    {{#if this.availableOptions}}
                        {{#each this.availableOptions}}
                            <option value="{{this}}">
                                {{localize this}}
                            </option>
                        {{/each}}
                    {{/if}}
                    {{#unless this.availableOptions}}
                        {{#each ../this.availableOptions}}
                            <option value="{{this}}">
                                {{localize this}}
                            </option>
                        {{/each}}
                    {{/unless}}
                </select>
            </div>
        {{/each}}

    {{/each}}
    <h3>{{localize "PF2EMONSTERMAKER.loreSkills"}}</h3>
    <div id="loreSkillsContainer"></div>
    <div class="form-group setting">
        <button type="button" id="addLoreButton" class="monsterMakerAddButton">{{localize "PF2EMONSTERMAKER.addLore"}}</button>
    </div>
    <div class="buttons">
        <button type="button" id="monsterMakerResetButton" class="monsterMakerResetButton">{{localize "PF2EMONSTERMAKER.resetDefaults"}}</button>
        <button type="submit" id="monsterMakerFormSubmit">Submit</button>
    </div>

</form>
<script>
    var monsterCreatureStatistics = {{{json CreatureStatistics}}};
    var monsterCreatureRoadmaps = {{{json RoadMaps}}};
    var detectedStats = {{{json detectedStats}}};
    var detectedTraits = {{{json detectedTraits}}};
    var detectedLoreSkills = {{{json detectedLoreSkills}}};
    var actorLevel = String({{{json actorLevel}}});
    
    console.log("Monster Maker Init - actorLevel:", actorLevel, "detectedStats:", detectedStats);
    
    function setDefaults() {
        for (const category of monsterCreatureStatistics) {
            for (const statistic of category.statisticEntries) {
                let element = document.getElementById("monsterMaker" + statistic.name)
                if (element) {
                    element.value = category.defaultValue;
                }
            }
        }
    }
    
    function setDetectedStats() {
        console.log("setDetectedStats called with level:", actorLevel, "stats:", detectedStats);
        
        // First set defaults
        setDefaults();
        
        // Set the actor's level
        const levelSelect = document.getElementById('monsterMakerLevel');
        if (levelSelect && actorLevel && actorLevel !== "undefined" && actorLevel !== "null") {
            console.log("Setting level to:", actorLevel);
            levelSelect.value = String(actorLevel);
        }
        
        // Then override with detected stats
        if (detectedStats && typeof detectedStats === 'object' && Object.keys(detectedStats).length > 0) {
            for (const [key, value] of Object.entries(detectedStats)) {
                let select = document.getElementById("monsterMaker" + key);
                if (select) {
                    console.log("Setting", key, "to", value);
                    select.value = value;
                } else {
                    console.log("Could not find select for:", key);
                }
            }
        } else {
            console.log("No detected stats to apply");
        }
    }
    
    function setRoadmap(selectedRoadmap) {
        let roadmapValue = selectedRoadmap.value;
        if (roadmapValue === 'Default') {
            setDetectedStats();
        } else if(monsterCreatureRoadmaps[roadmapValue]) {
            setDefaults();
            let roadmap = monsterCreatureRoadmaps[roadmapValue]
            for (const [key, value] of Object.entries(roadmap)) {
                let select = document.getElementById("monsterMaker" + key)
                if(select) {
                    select.value = value
                }
            }
        }
    }
    
    // Initialize with detected stats instead of defaults
    // Use setTimeout to ensure DOM is ready
    setTimeout(function() {
        setDetectedStats();
    }, 0);

    // Lore Skills functionality
    let loreCounter = 0;
    const loreOptions = ['PF2EMONSTERMAKER.none', 'PF2EMONSTERMAKER.terrible', 'PF2EMONSTERMAKER.low', 'PF2EMONSTERMAKER.moderate', 'PF2EMONSTERMAKER.high', 'PF2EMONSTERMAKER.extreme'];
    
    function addLoreSkill() {
        const container = document.getElementById('loreSkillsContainer');
        const loreId = loreCounter++;
        
        const loreDiv = document.createElement('div');
        loreDiv.className = 'form-group setting lore-entry';
        loreDiv.id = 'loreEntry' + loreId;
        
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.name = 'loreName' + loreId;
        nameInput.placeholder = '{{localize "PF2EMONSTERMAKER.loreName"}}';
        nameInput.className = 'monsterMakerFormText lore-name-input';
        
        const levelSelect = document.createElement('select');
        levelSelect.name = 'loreLevel' + loreId;
        levelSelect.className = 'monsterMakerFormTextSmall';
        
        for (const option of loreOptions) {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = game.i18n.localize(option);
            if (option === 'PF2EMONSTERMAKER.moderate') {
                opt.selected = true;
            }
            levelSelect.appendChild(opt);
        }
        
        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.textContent = '✕';
        removeButton.className = 'monsterMakerRemoveButton';
        removeButton.onclick = function() {
            container.removeChild(loreDiv);
        };
        
        loreDiv.appendChild(nameInput);
        loreDiv.appendChild(levelSelect);
        loreDiv.appendChild(removeButton);
        container.appendChild(loreDiv);
    }
    
    document.getElementById('addLoreButton').addEventListener('click', addLoreSkill);

    // Traits functionality
    const traits = [];
    const traitsInput = document.getElementById('monsterMakerTraitsInput');
    const traitsContainer = document.getElementById('traitsTagsContainer');
    const traitsHidden = document.getElementById('monsterMakerTraitsHidden');

    function updateTraitsHidden() {
        traitsHidden.value = traits.join(',');
    }

    function addTrait(traitName) {
        const trimmed = traitName.trim().toLowerCase();
        if (trimmed && !traits.includes(trimmed)) {
            traits.push(trimmed);
            renderTraits();
            updateTraitsHidden();
        }
    }

    function removeTrait(traitName) {
        const index = traits.indexOf(traitName);
        if (index > -1) {
            traits.splice(index, 1);
            renderTraits();
            updateTraitsHidden();
        }
    }

    function renderTraits() {
        traitsContainer.innerHTML = '';
        for (const trait of traits) {
            const tag = document.createElement('span');
            tag.className = 'trait-tag';
            tag.innerHTML = trait + '<button type="button" class="trait-remove" onclick="removeTrait(\'' + trait + '\')">✕</button>';
            traitsContainer.appendChild(tag);
        }
    }

    traitsInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            addTrait(this.value);
            this.value = '';
        }
    });

    traitsInput.addEventListener('blur', function() {
        if (this.value.trim()) {
            addTrait(this.value);
            this.value = '';
        }
    });
    
    // Initialize detected traits
    if (detectedTraits && detectedTraits.length > 0) {
        for (const trait of detectedTraits) {
            addTrait(trait);
        }
    }
    
    // Initialize detected lore skills
    function addLoreSkillWithValues(name, level) {
        const container = document.getElementById('loreSkillsContainer');
        const loreId = loreCounter++;
        
        const loreDiv = document.createElement('div');
        loreDiv.className = 'form-group setting lore-entry';
        loreDiv.id = 'loreEntry' + loreId;
        
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.name = 'loreName' + loreId;
        nameInput.value = name;
        nameInput.placeholder = '{{localize "PF2EMONSTERMAKER.loreName"}}';
        nameInput.className = 'monsterMakerFormText lore-name-input';
        
        const levelSelect = document.createElement('select');
        levelSelect.name = 'loreLevel' + loreId;
        levelSelect.className = 'monsterMakerFormTextSmall';
        
        for (const option of loreOptions) {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = game.i18n.localize(option);
            if (option === level) {
                opt.selected = true;
            }
            levelSelect.appendChild(opt);
        }
        
        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.textContent = '✕';
        removeButton.className = 'monsterMakerRemoveButton';
        removeButton.onclick = function() {
            container.removeChild(loreDiv);
        };
        
        loreDiv.appendChild(nameInput);
        loreDiv.appendChild(levelSelect);
        loreDiv.appendChild(removeButton);
        container.appendChild(loreDiv);
    }
    
    if (detectedLoreSkills && detectedLoreSkills.length > 0) {
        for (const lore of detectedLoreSkills) {
            addLoreSkillWithValues(lore.name, lore.level);
        }
    }
    
    // Reset to Defaults button
    document.getElementById('monsterMakerResetButton').addEventListener('click', function() {
        // Reset stats to defaults
        setDefaults();
        
        // Reset level to 1
        document.getElementById('monsterMakerLevel').value = '1';
        
        // Reset roadmap selector
        document.getElementById('monsterMakerRoadmap').value = 'Default';
        
        // Clear traits
        traits.length = 0;
        renderTraits();
        updateTraitsHidden();
        
        // Clear lore skills
        document.getElementById('loreSkillsContainer').innerHTML = '';
        loreCounter = 0;
    });
</script>