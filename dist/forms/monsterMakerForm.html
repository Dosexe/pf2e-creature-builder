<form>
    <h1>{{localize "PF2EMONSTERMAKER.title"}}</h1>
    <h2>{{localize "PF2EMONSTERMAKER.nameLevelRoadmap"}}</h2>
    <div class="form-group setting">
        <label for="monsterMakerName" class="monsterMakerFormText">
            {{localize "PF2EMONSTERMAKER.name"}}
        </label>
        <input id="monsterMakerName" name="PF2EMONSTERMAKER.name" placeholder="{{name}}" class="monsterMakerFormText">
    </div>
    <div class="form-group setting">
        <label for="monsterMakerLevel" class="monsterMakerFormText">
            {{localize "PF2EMONSTERMAKER.level"}}
        </label>
        <select name="PF2EMONSTERMAKER.level" id="monsterMakerLevel" class="monsterMakerFormTextSmall">
            {{#each Levels}}
                <option value="{{this}}">{{this}}</option>
            {{/each}}
        </select>
    </div>
    <div class="form-group setting">
        <label for="monsterMakerRoadmap" class="monsterMakerFormText">
            {{localize "PF2EMONSTERMAKER.roadmap"}}
        </label>
        <select id="monsterMakerRoadmap" class="monsterMakerFormTextSmall" onchange=setRoadmap(this)>
            <option value="Default" selected>Default</option>
            {{#each RoadMaps}}
                <option value="{{@key}}">{{localize @key}}</option>
            {{/each}}
        </select>
    </div>
    <div class="form-group setting">
        <label for="monsterMakerTraits" class="monsterMakerFormText">
            {{localize "PF2EMONSTERMAKER.traits"}}
        </label>
        <div class="traits-container">
            <div id="traitsTagsContainer" class="traits-tags"></div>
            <input type="text" id="monsterMakerTraitsInput" class="monsterMakerFormText traits-input" placeholder="{{localize "PF2EMONSTERMAKER.traitsPlaceholder"}}">
        </div>
        <input type="hidden" name="PF2EMONSTERMAKER.traits" id="monsterMakerTraitsHidden" value="">
    </div>
    {{#each CreatureStatistics}}
        <h3>{{localize this.name}}</h3>
        {{#each this.statisticEntries}}
            <div class="form-group setting">
                <label for="{{concat 'monsterMaker' this.name}}" class="monsterMakerFormText">
                    {{localize this.name}}
                </label>
                <select id="{{concat 'monsterMaker' this.name}}" name="{{this.name}}" class="monsterMakerFormTextSmall">
                    {{#if this.availableOptions}}
                        {{#each this.availableOptions}}
                            <option value="{{this}}">
                                {{localize this}}
                            </option>
                        {{/each}}
                    {{/if}}
                    {{#unless this.availableOptions}}
                        {{#each ../this.availableOptions}}
                            <option value="{{this}}">
                                {{localize this}}
                            </option>
                        {{/each}}
                    {{/unless}}
                </select>
            </div>
        {{/each}}

    {{/each}}
    <h3>{{localize "PF2EMONSTERMAKER.loreSkills"}}</h3>
    <div id="loreSkillsContainer"></div>
    <div class="form-group setting">
        <button type="button" id="addLoreButton" class="monsterMakerAddButton">{{localize "PF2EMONSTERMAKER.addLore"}}</button>
    </div>
    <div class="buttons">
        <button type="button" id="monsterMakerResetButton" class="monsterMakerResetButton">{{localize "PF2EMONSTERMAKER.resetDefaults"}}</button>
        <button type="submit" id="monsterMakerFormSubmit">Submit</button>
    </div>

</form>
<script>
(function() {
    // All variables are now scoped to this IIFE, preventing conflicts on re-render
    var monsterCreatureStatistics = {{{json CreatureStatistics}}};
    var monsterCreatureRoadmaps = {{{json RoadMaps}}};
    var detectedStats = {{{json detectedStats}}};
    var detectedTraits = {{{json detectedTraits}}};
    var detectedLoreSkills = {{{json detectedLoreSkills}}};
    var actorLevel = String({{{json actorLevel}}});
    var loreCounter = 0;
    var traits = [];
    var loreOptions = ['PF2EMONSTERMAKER.none', 'PF2EMONSTERMAKER.terrible', 'PF2EMONSTERMAKER.low', 'PF2EMONSTERMAKER.moderate', 'PF2EMONSTERMAKER.high', 'PF2EMONSTERMAKER.extreme'];
    
    console.log("Monster Maker Init - actorLevel:", actorLevel, "detectedStats:", detectedStats);
    
    function setDefaults() {
        for (var i = 0; i < monsterCreatureStatistics.length; i++) {
            var category = monsterCreatureStatistics[i];
            for (var j = 0; j < category.statisticEntries.length; j++) {
                var statistic = category.statisticEntries[j];
                var element = document.getElementById("monsterMaker" + statistic.name);
                if (element) {
                    element.value = category.defaultValue;
                }
            }
        }
    }
    
    function setDetectedStats() {
        console.log("setDetectedStats called with level:", actorLevel, "stats:", detectedStats);
        
        // First set defaults
        setDefaults();
        
        // Set the actor's level
        var levelSelect = document.getElementById('monsterMakerLevel');
        if (levelSelect && actorLevel && actorLevel !== "undefined" && actorLevel !== "null") {
            console.log("Setting level to:", actorLevel);
            levelSelect.value = String(actorLevel);
        }
        
        // Then override with detected stats
        if (detectedStats && typeof detectedStats === 'object' && Object.keys(detectedStats).length > 0) {
            for (var key in detectedStats) {
                if (detectedStats.hasOwnProperty(key)) {
                    var value = detectedStats[key];
                    var select = document.getElementById("monsterMaker" + key);
                    if (select) {
                        console.log("Setting", key, "to", value);
                        select.value = value;
                    }
                }
            }
        }
    }
    
    // Expose setRoadmap to global scope for the onchange handler
    window.setRoadmap = function(selectedRoadmap) {
        var roadmapValue = selectedRoadmap.value;
        if (roadmapValue === 'Default') {
            setDetectedStats();
        } else if(monsterCreatureRoadmaps[roadmapValue]) {
            setDefaults();
            var roadmap = monsterCreatureRoadmaps[roadmapValue];
            for (var key in roadmap) {
                if (roadmap.hasOwnProperty(key)) {
                    var select = document.getElementById("monsterMaker" + key);
                    if (select) {
                        select.value = roadmap[key];
                    }
                }
            }
        }
    };
    
    // Traits functionality
    var traitsInput = document.getElementById('monsterMakerTraitsInput');
    var traitsContainer = document.getElementById('traitsTagsContainer');
    var traitsHidden = document.getElementById('monsterMakerTraitsHidden');

    function updateTraitsHidden() {
        traitsHidden.value = traits.join(',');
    }

    function addTrait(traitName) {
        var trimmed = traitName.trim().toLowerCase();
        if (trimmed && traits.indexOf(trimmed) === -1) {
            traits.push(trimmed);
            renderTraits();
            updateTraitsHidden();
        }
    }

    function renderTraits() {
        traitsContainer.innerHTML = '';
        for (var i = 0; i < traits.length; i++) {
            var trait = traits[i];
            var tag = document.createElement('span');
            tag.className = 'trait-tag';
            tag.textContent = trait;
            
            var removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'trait-remove';
            removeBtn.textContent = '✕';
            removeBtn.setAttribute('data-trait', trait);
            removeBtn.onclick = function() {
                var traitToRemove = this.getAttribute('data-trait');
                var index = traits.indexOf(traitToRemove);
                if (index > -1) {
                    traits.splice(index, 1);
                    renderTraits();
                    updateTraitsHidden();
                }
            };
            
            tag.appendChild(removeBtn);
            traitsContainer.appendChild(tag);
        }
    }

    traitsInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            addTrait(this.value);
            this.value = '';
        }
    });

    traitsInput.addEventListener('blur', function() {
        if (this.value.trim()) {
            addTrait(this.value);
            this.value = '';
        }
    });

    // Lore Skills functionality
    function addLoreSkill(name, level) {
        var container = document.getElementById('loreSkillsContainer');
        var loreId = loreCounter++;
        
        var loreDiv = document.createElement('div');
        loreDiv.className = 'form-group setting lore-entry';
        loreDiv.id = 'loreEntry' + loreId;
        
        var nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.name = 'loreName' + loreId;
        nameInput.value = name || '';
        nameInput.placeholder = '{{localize "PF2EMONSTERMAKER.loreName"}}';
        nameInput.className = 'monsterMakerFormText lore-name-input';
        
        var levelSelect = document.createElement('select');
        levelSelect.name = 'loreLevel' + loreId;
        levelSelect.className = 'monsterMakerFormTextSmall';
        
        for (var i = 0; i < loreOptions.length; i++) {
            var option = loreOptions[i];
            var opt = document.createElement('option');
            opt.value = option;
            opt.textContent = game.i18n.localize(option);
            if ((level && option === level) || (!level && option === 'PF2EMONSTERMAKER.moderate')) {
                opt.selected = true;
            }
            levelSelect.appendChild(opt);
        }
        
        var removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.textContent = '✕';
        removeButton.className = 'monsterMakerRemoveButton';
        removeButton.onclick = function() {
            container.removeChild(loreDiv);
        };
        
        loreDiv.appendChild(nameInput);
        loreDiv.appendChild(levelSelect);
        loreDiv.appendChild(removeButton);
        container.appendChild(loreDiv);
    }
    
    document.getElementById('addLoreButton').addEventListener('click', function() {
        addLoreSkill();
    });

    // Reset to Defaults button
    document.getElementById('monsterMakerResetButton').addEventListener('click', function() {
        setDefaults();
        document.getElementById('monsterMakerLevel').value = '1';
        document.getElementById('monsterMakerRoadmap').value = 'Default';
        traits.length = 0;
        renderTraits();
        updateTraitsHidden();
        document.getElementById('loreSkillsContainer').innerHTML = '';
        loreCounter = 0;
    });
    
    // Initialize detected traits
    if (detectedTraits && detectedTraits.length > 0) {
        for (var i = 0; i < detectedTraits.length; i++) {
            addTrait(detectedTraits[i]);
        }
    }
    
    // Initialize detected lore skills
    if (detectedLoreSkills && detectedLoreSkills.length > 0) {
        for (var i = 0; i < detectedLoreSkills.length; i++) {
            addLoreSkill(detectedLoreSkills[i].name, detectedLoreSkills[i].level);
        }
    }
    
    // Initialize with detected stats
    setTimeout(function() {
        setDetectedStats();
    }, 0);
})();
</script>