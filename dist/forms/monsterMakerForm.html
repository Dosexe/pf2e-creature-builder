<form>
    <h1>{{localize "PF2EMONSTERMAKER.title"}}</h1>
    <h2>{{localize "PF2EMONSTERMAKER.nameLevelRoadmap"}}</h2>
    <div class="form-group setting">
        <label for="monsterMakerName" class="monsterMakerFormText">
            {{localize "PF2EMONSTERMAKER.name"}}
        </label>
        <input id="monsterMakerName" name="PF2EMONSTERMAKER.name" placeholder="{{name}}" class="monsterMakerFormText">
    </div>
    <div class="form-group setting">
        <label for="monsterMakerLevel" class="monsterMakerFormText">
            {{localize "PF2EMONSTERMAKER.level"}}
        </label>
        <select name="PF2EMONSTERMAKER.level" id="monsterMakerLevel" class="monsterMakerFormTextSmall">
            {{#each Levels}}
                <option value="{{this}}">{{this}}</option>
            {{/each}}
        </select>
    </div>
    <div class="form-group setting">
        <label for="monsterMakerRoadmap" class="monsterMakerFormText">
            {{localize "PF2EMONSTERMAKER.roadmap"}}
        </label>
        <select id="monsterMakerRoadmap" class="monsterMakerFormTextSmall" onchange=setRoadmap(this)>
            <option value="Default" selected>Default</option>
            {{#each RoadMaps}}
                <option value="{{@key}}">{{localize @key}}</option>
            {{/each}}
        </select>
    </div>
    <div class="form-group setting">
        <label for="monsterMakerTraits" class="monsterMakerFormText">
            {{localize "PF2EMONSTERMAKER.traits"}}
        </label>
        <div class="traits-container">
            <tags class="tagify tags paizo-style" tabindex="-1" id="traitsTagify">
                <span contenteditable="true" tabindex="0" data-placeholder="{{localize "PF2EMONSTERMAKER.traitsPlaceholder"}}" class="tagify__input" role="textbox" aria-autocomplete="both" aria-multiline="false" id="monsterMakerTraitsInput"></span>
            </tags>
            <div id="traitsDropdown" class="traits-dropdown tagify__dropdown" role="listbox" aria-labelledby="dropdown" placement="bottom" position="all">
                <div data-selector="tagify-suggestions-wrapper" class="tagify__dropdown__wrapper">
                    <header data-selector="tagify-suggestions-header" class="tagify__dropdown__header"></header>
                </div>
            </div>
        </div>
        <input type="hidden" name="PF2EMONSTERMAKER.traits" id="monsterMakerTraitsHidden" value="">
    </div>
    {{#each CreatureStatistics}}
        <details class="collapsible-section" data-section-name="{{this.name}}" open>
            <summary class="collapsible-header">
                <h3>{{localize this.name}}</h3>
            </summary>
            <div class="collapsible-content">
                {{#each this.statisticEntries}}
                    <div class="form-group setting">
                        <label for="{{concat 'monsterMaker' this.name}}" class="monsterMakerFormText">
                            {{localize this.name}}
                        </label>
                        <select id="{{concat 'monsterMaker' this.name}}" name="{{this.name}}" class="monsterMakerFormTextSmall">
                            {{#if this.availableOptions}}
                                {{#each this.availableOptions}}
                                    <option value="{{this}}">
                                        {{localize this}}
                                    </option>
                                {{/each}}
                            {{/if}}
                            {{#unless this.availableOptions}}
                                {{#each ../this.availableOptions}}
                                    <option value="{{this}}">
                                        {{localize this}}
                                    </option>
                                {{/each}}
                            {{/unless}}
                        </select>
                    </div>
                {{/each}}
            </div>
        </details>
    {{/each}}
    <details class="collapsible-section" id="section-lore" open>
        <summary class="collapsible-header">
            <h3>{{localize "PF2EMONSTERMAKER.loreSkills"}}</h3>
        </summary>
        <div class="collapsible-content">
            <div id="loreSkillsContainer"></div>
            <div class="form-group setting">
                <button type="button" id="addLoreButton" class="monsterMakerAddButton">{{localize "PF2EMONSTERMAKER.addLore"}}</button>
            </div>
        </div>
    </details>
    <div class="form-divider"></div>
    <div class="buttons">
        <button type="button" id="monsterMakerResetButton" class="monsterMakerResetButton">{{localize "PF2EMONSTERMAKER.resetDefaults"}}</button>
        <button type="submit" id="monsterMakerFormSubmit">Submit</button>
    </div>

</form>
<script>
(function() {
    // All variables are now scoped to this IIFE, preventing conflicts on re-render
    var monsterCreatureStatistics = {{{json CreatureStatistics}}};
    var monsterCreatureRoadmaps = {{{json RoadMaps}}};
    var detectedStats = {{{json detectedStats}}};
    var detectedTraits = {{{json detectedTraits}}};
    var detectedLoreSkills = {{{json detectedLoreSkills}}};
    var actorLevel = String({{{json actorLevel}}});
    var loreCounter = 0;
    var traits = [];
    var loreOptions = ['PF2EMONSTERMAKER.none', 'PF2EMONSTERMAKER.terrible', 'PF2EMONSTERMAKER.low', 'PF2EMONSTERMAKER.moderate', 'PF2EMONSTERMAKER.high', 'PF2EMONSTERMAKER.extreme'];
    
    console.log("Monster Maker Init - actorLevel:", actorLevel, "detectedStats:", detectedStats);
    
    function setDefaults() {
        for (var i = 0; i < monsterCreatureStatistics.length; i++) {
            var category = monsterCreatureStatistics[i];
            for (var j = 0; j < category.statisticEntries.length; j++) {
                var statistic = category.statisticEntries[j];
                var element = document.getElementById("monsterMaker" + statistic.name);
                if (element) {
                    element.value = category.defaultValue;
                }
            }
        }
    }
    
    function setDetectedStats() {
        console.log("setDetectedStats called with level:", actorLevel, "stats:", detectedStats);
        
        // First set defaults
        setDefaults();
        
        // Set the actor's level
        var levelSelect = document.getElementById('monsterMakerLevel');
        if (levelSelect && actorLevel && actorLevel !== "undefined" && actorLevel !== "null") {
            console.log("Setting level to:", actorLevel);
            levelSelect.value = String(actorLevel);
        }
        
        // Then override with detected stats
        if (detectedStats && typeof detectedStats === 'object' && Object.keys(detectedStats).length > 0) {
            for (var key in detectedStats) {
                if (detectedStats.hasOwnProperty(key)) {
                    var value = detectedStats[key];
                    var select = document.getElementById("monsterMaker" + key);
                    if (select) {
                        console.log("Setting", key, "to", value);
                        select.value = value;
                    }
                }
            }
        }
    }
    
    // Expose setRoadmap to global scope for the onchange handler
    window.setRoadmap = function(selectedRoadmap) {
        var roadmapValue = selectedRoadmap.value;
        if (roadmapValue === 'Default') {
            setDetectedStats();
        } else if(monsterCreatureRoadmaps[roadmapValue]) {
            setDefaults();
            var roadmap = monsterCreatureRoadmaps[roadmapValue];
            for (var key in roadmap) {
                if (roadmap.hasOwnProperty(key)) {
                    var select = document.getElementById("monsterMaker" + key);
                    if (select) {
                        select.value = roadmap[key];
                    }
                }
            }
        }
    };
    
    // PF2e Traits list for autocomplete
    var pf2eTraits = [
        'aberration', 'acid', 'aeon', 'aesir', 'agathion', 'air', 'aiuvarin', 'alchemical',
        'amphibious', 'anadi', 'android', 'angel', 'animal', 'anugobu', 'aphorite', 'aquatic',
        'archon', 'arcane', 'ardande', 'astral', 'automaton', 'azarketi', 'azata',
        'beast', 'beastkin', 'boggard',
        'caligni', 'catfolk', 'celestial', 'changeling', 'chaotic', 'clockwork', 'cold', 'construct',
        'daemon', 'darvakka', 'demon', 'dero', 'devil', 'dhampir', 'dinosaur', 'divine', 'dragon', 'dream', 'drow', 'duergar', 'duskwalker', 'dwarf',
        'earth', 'eidolon', 'electricity', 'elemental', 'elf', 'ethereal', 'evil',
        'fetchling', 'fey', 'fiend', 'fire', 'fleshwarp', 'flumph', 'force', 'fungus',
        'ganzi', 'genie', 'ghoran', 'ghost', 'ghoul', 'giant', 'gnoll', 'gnome', 'goblin', 'golem', 'good', 'goloma', 'gremlin', 'grioth', 'grippli',
        'hag', 'half-elf', 'half-orc', 'halfling', 'hobgoblin', 'human', 'humanoid',
        'ifrit', 'illusion', 'incorporeal', 'inevitable', 'kami', 'kashrishi', 'kitsune', 'kobold',
        'lawful', 'leshy', 'light', 'linnorm', 'lizardfolk', 'locathah',
        'mental', 'merfolk', 'mindless', 'minion', 'monitor', 'morlock', 'mortic', 'mummy', 'munavri', 'mutant',
        'nagaji', 'negative', 'neutral', 'nightmare', 'nightshade', 'nymph',
        'occult', 'ooze', 'orc', 'oread',
        'petitioner', 'phantom', 'plant', 'poison', 'positive', 'primal', 'protean', 'psychic', 'psychopomp', 'poppet',
        'qlippoth',
        'rakshasa', 'rare', 'ratfolk', 'reflection', 'robot',
        'sahkil', 'salamander', 'sea devil', 'serpentfolk', 'shadow', 'shisk', 'shoony', 'skelm', 'skeleton', 'skulk', 'sonic', 'soulbound', 'spirit', 'spriggan', 'sprite', 'strix', 'summoned', 'swarm', 'sylph',
        'talos', 'tanuki', 'tengu', 'time', 'titan', 'troll', 'troop',
        'uncommon', 'undead', 'undine', 'unique', 'urdefhan',
        'vampire', 'vanara', 'velstrac', 'vishkanya', 'vitality', 'void',
        'water', 'werecreature', 'wild hunt', 'witch', 'wyrwood', 'wyvern',
        'xulgath',
        'yaksha', 'yeti', 'zombie'
    ];
    
    // Traits functionality using Foundry's tagify classes
    var traitsInput = document.getElementById('monsterMakerTraitsInput');
    var traitsTagify = document.getElementById('traitsTagify');
    var traitsHidden = document.getElementById('monsterMakerTraitsHidden');
    var traitsDropdown = document.getElementById('traitsDropdown');
    var traitsDropdownWrapper = traitsDropdown.querySelector('.tagify__dropdown__wrapper');
    var selectedDropdownIndex = -1;

    function updateTraitsHidden() {
        traitsHidden.value = traits.join(',');
    }

    function capitalizeFirst(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function addTrait(traitName, skipFocus) {
        var trimmed = traitName.trim().toLowerCase();
        if (trimmed && traits.indexOf(trimmed) === -1) {
            traits.push(trimmed);
            renderTraits();
            updateTraitsHidden();
        }
        hideDropdown();
        traitsInput.textContent = '';
        // Only focus if not skipped (e.g., during initialization)
        if (!skipFocus) {
            traitsInput.focus();
        }
    }

    function removeTrait(traitToRemove) {
        var index = traits.indexOf(traitToRemove);
        if (index > -1) {
            traits.splice(index, 1);
            renderTraits();
            updateTraitsHidden();
        }
    }

    function renderTraits() {
        // Remove existing tags (but keep the input span)
        var existingTags = traitsTagify.querySelectorAll('tag');
        existingTags.forEach(function(tag) {
            tag.remove();
        });
        
        // Add tags before the input
        for (var i = 0; i < traits.length; i++) {
            var trait = traits[i];
            var tag = document.createElement('tag');
            tag.className = 'tagify__tag tagify--noAnim';
            tag.setAttribute('contenteditable', 'false');
            tag.setAttribute('spellcheck', 'false');
            tag.setAttribute('tabindex', '-1');
            tag.setAttribute('value', capitalizeFirst(trait));
            tag.setAttribute('data-trait', trait);
            
            var removeBtn = document.createElement('x');
            removeBtn.className = 'tagify__tag__removeBtn';
            removeBtn.setAttribute('role', 'button');
            removeBtn.setAttribute('aria-label', 'remove tag');
            
            var textDiv = document.createElement('div');
            var textSpan = document.createElement('span');
            textSpan.className = 'tagify__tag-text';
            textSpan.textContent = capitalizeFirst(trait);
            textDiv.appendChild(textSpan);
            
            tag.appendChild(removeBtn);
            tag.appendChild(textDiv);
            
            // Insert before the input span
            traitsTagify.insertBefore(tag, traitsInput);
        }
        
        // Add click handlers for remove buttons
        var removeBtns = traitsTagify.querySelectorAll('.tagify__tag__removeBtn');
        removeBtns.forEach(function(btn) {
            btn.onclick = function(e) {
                e.stopPropagation();
                var tag = this.parentElement;
                var traitToRemove = tag.getAttribute('data-trait');
                removeTrait(traitToRemove);
            };
        });
    }

    function positionDropdown() {
        // Get the bounding rectangle of the tagify container
        var rect = traitsTagify.getBoundingClientRect();
        
        // Position the dropdown below the input, matching its width
        traitsDropdown.style.left = rect.left + 'px';
        traitsDropdown.style.top = rect.bottom + 'px';
        traitsDropdown.style.width = rect.width + 'px';
    }
    
    function showDropdown(filter) {
        var filterLower = (filter || '').toLowerCase().trim();
        var filtered = pf2eTraits.filter(function(t) {
            return t.indexOf(filterLower) !== -1 && traits.indexOf(t) === -1;
        });
        
        // Clear existing items from wrapper (keep header)
        var existingItems = traitsDropdownWrapper.querySelectorAll('.tagify__dropdown__item');
        existingItems.forEach(function(item) { item.remove(); });
        selectedDropdownIndex = -1;
        
        var itemCount = 0;
        
        // If user typed something not in the list, offer to add it
        if (filterLower && pf2eTraits.indexOf(filterLower) === -1 && traits.indexOf(filterLower) === -1) {
            var customItem = document.createElement('div');
            customItem.className = 'tagify__dropdown__item custom-entry';
            customItem.id = 'custom-' + filterLower;
            customItem.setAttribute('value', filterLower);
            customItem.setAttribute('mappedvalue', filterLower);
            customItem.setAttribute('data-trait', filterLower);
            customItem.setAttribute('tabindex', '0');
            customItem.setAttribute('role', 'option');
            customItem.textContent = '(Add "' + filterLower + '")';
            customItem.onclick = function() {
                addTrait(this.getAttribute('data-trait'));
            };
            traitsDropdownWrapper.appendChild(customItem);
            itemCount++;
        }
        
        // Show matching traits (limit to 15 for performance)
        var shown = 0;
        for (var i = 0; i < filtered.length && shown < 15; i++) {
            var traitName = filtered[i];
            var displayName = capitalizeFirst(traitName);
            var item = document.createElement('div');
            item.className = 'tagify__dropdown__item';
            item.id = traitName.replace(/\s+/g, '-');
            item.setAttribute('value', displayName);
            item.setAttribute('mappedvalue', displayName);
            item.setAttribute('data-trait', traitName);
            item.setAttribute('tabindex', '0');
            item.setAttribute('role', 'option');
            item.textContent = displayName;
            item.onclick = function() {
                addTrait(this.getAttribute('data-trait'));
            };
            traitsDropdownWrapper.appendChild(item);
            shown++;
            itemCount++;
        }
        
        if (itemCount > 0) {
            // Position and show the dropdown
            positionDropdown();
            traitsDropdown.classList.add('show');
        } else {
            hideDropdown();
        }
    }

    function hideDropdown() {
        traitsDropdown.classList.remove('show');
        selectedDropdownIndex = -1;
    }

    function updateDropdownSelection() {
        var items = traitsDropdownWrapper.querySelectorAll('.tagify__dropdown__item');
        for (var i = 0; i < items.length; i++) {
            if (i === selectedDropdownIndex) {
                items[i].classList.add('tagify__dropdown__item--active');
                items[i].scrollIntoView({ block: 'nearest' });
            } else {
                items[i].classList.remove('tagify__dropdown__item--active');
            }
        }
    }

    function getInputText() {
        return traitsInput.textContent || '';
    }

    traitsInput.addEventListener('input', function() {
        showDropdown(getInputText());
    });

    // Focus alone doesn't show dropdown - only click or typing does

    traitsInput.addEventListener('keydown', function(e) {
        var items = traitsDropdownWrapper.querySelectorAll('.tagify__dropdown__item');
        var inputText = getInputText();
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (traitsDropdown.classList.contains('show')) {
                selectedDropdownIndex = Math.min(selectedDropdownIndex + 1, items.length - 1);
                updateDropdownSelection();
            } else {
                showDropdown(inputText);
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (traitsDropdown.classList.contains('show')) {
                selectedDropdownIndex = Math.max(selectedDropdownIndex - 1, 0);
                updateDropdownSelection();
            }
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedDropdownIndex >= 0 && items[selectedDropdownIndex]) {
                addTrait(items[selectedDropdownIndex].getAttribute('data-trait'));
            } else if (inputText.trim()) {
                addTrait(inputText);
            }
        } else if (e.key === 'Escape') {
            hideDropdown();
        } else if (e.key === 'Backspace' && inputText === '' && traits.length > 0) {
            // Remove last trait when backspace is pressed on empty input
            e.preventDefault();
            traits.pop();
            renderTraits();
            updateTraitsHidden();
        }
    });

    // Click on tagify container focuses input and shows dropdown
    traitsTagify.addEventListener('click', function(e) {
        // Don't interfere with remove button clicks
        if (e.target.classList.contains('tagify__tag__removeBtn')) {
            return;
        }
        traitsInput.focus();
        showDropdown(getInputText());
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!traitsTagify.contains(e.target) && !traitsDropdown.contains(e.target)) {
            hideDropdown();
        }
    });
    
    // Reposition dropdown on scroll/resize to keep it attached to input
    window.addEventListener('scroll', function() {
        if (traitsDropdown.classList.contains('show')) {
            positionDropdown();
        }
    }, true);
    
    window.addEventListener('resize', function() {
        if (traitsDropdown.classList.contains('show')) {
            positionDropdown();
        }
    });

    // Lore Skills functionality
    function addLoreSkill(name, level) {
        var container = document.getElementById('loreSkillsContainer');
        var loreId = loreCounter++;
        
        var loreDiv = document.createElement('div');
        loreDiv.className = 'form-group setting lore-entry';
        loreDiv.id = 'loreEntry' + loreId;
        
        var nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.name = 'loreName' + loreId;
        nameInput.value = name || '';
        nameInput.placeholder = '{{localize "PF2EMONSTERMAKER.loreName"}}';
        nameInput.className = 'monsterMakerFormText lore-name-input';
        
        var levelSelect = document.createElement('select');
        levelSelect.name = 'loreLevel' + loreId;
        levelSelect.className = 'monsterMakerFormTextSmall';
        
        for (var i = 0; i < loreOptions.length; i++) {
            var option = loreOptions[i];
            var opt = document.createElement('option');
            opt.value = option;
            opt.textContent = game.i18n.localize(option);
            if ((level && option === level) || (!level && option === 'PF2EMONSTERMAKER.moderate')) {
                opt.selected = true;
            }
            levelSelect.appendChild(opt);
        }
        
        var removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.textContent = 'âœ•';
        removeButton.className = 'monsterMakerRemoveButton';
        removeButton.onclick = function() {
            container.removeChild(loreDiv);
        };
        
        loreDiv.appendChild(nameInput);
        loreDiv.appendChild(levelSelect);
        loreDiv.appendChild(removeButton);
        container.appendChild(loreDiv);
    }
    
    document.getElementById('addLoreButton').addEventListener('click', function() {
        addLoreSkill();
    });

    // Reset to Defaults button
    document.getElementById('monsterMakerResetButton').addEventListener('click', function() {
        setDefaults();
        document.getElementById('monsterMakerLevel').value = '1';
        document.getElementById('monsterMakerRoadmap').value = 'Default';
        traits.length = 0;
        renderTraits();
        updateTraitsHidden();
        document.getElementById('loreSkillsContainer').innerHTML = '';
        loreCounter = 0;
    });
    
    // Initialize detected traits (skip focus to prevent dropdown from showing)
    if (detectedTraits && detectedTraits.length > 0) {
        for (var i = 0; i < detectedTraits.length; i++) {
            addTrait(detectedTraits[i], true);
        }
    }
    
    // Initialize detected lore skills
    if (detectedLoreSkills && detectedLoreSkills.length > 0) {
        for (var i = 0; i < detectedLoreSkills.length; i++) {
            addLoreSkill(detectedLoreSkills[i].name, detectedLoreSkills[i].level);
        }
    }
    
    // Initialize with detected stats
    setTimeout(function() {
        setDetectedStats();
    }, 0);
    
    // Collapse Skills and Lore Skills sections by default on init
    function initCollapsibleSections() {
        var sections = document.querySelectorAll('details.collapsible-section');
        sections.forEach(function(section) {
            var sectionName = section.getAttribute('data-section-name');
            var sectionId = section.getAttribute('id');
            
            // Collapse Skills section by default (remove 'open' attribute)
            var isSkillsSection = sectionName && (
                sectionName.toLowerCase().indexOf('skill') !== -1 ||
                sectionName === 'PF2EMONSTERMAKER.skills'
            );
            
            // Also collapse Lore Skills section
            var isLoreSection = sectionId === 'section-lore';
            
            if (isSkillsSection || isLoreSection) {
                section.removeAttribute('open');
            }
        });
    }
    
    initCollapsibleSections();
})();
</script>